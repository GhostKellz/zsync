# zsync v0.7.3 Release Plan
## Cleanup & Zig 0.16 Compatibility Release

**Status**: Ready for release
**Date**: 2025-12-03

---

## Completed

### Codebase Cleanup (100 → 78 files in src/)
- [x] Removed compiled binaries from root (test-windows*.exe, *.pdb, libchannel.a)
- [x] Removed orphan test binaries (test_arraylist, test_read, test_sendfile, test_sleep, thread_pool_demo)
- [x] Removed versioned junk files (simple_test_v050.zig, test_v050_apis.zig)
- [x] Removed obsolete benchmark files (benchmark_*.zig, cli_example.zig, test_*.zig)
- [x] Removed obsolete build_v4.zig
- [x] Removed versioned examples (v031_features_demo.zig, v032_demo.zig, wasm_test.html)
- [x] Removed versioned tests (test_v031_features.zig, test_v032_features.zig, test_v070_features.zig)
- [x] Removed versioned src files (8 files: *_v2.zig, *_v4.zig, v1_showcase.zig)
- [x] Removed obsolete docs (DOCS.md, FUTURE.md)
- [x] Removed demo/test files (7 files: *_demo.zig, *_test.zig)
- [x] Removed domain-specific files (8 files: blockchain, crypto, zk, cuda, container, etc.)
- [x] Removed old/duplicate files (threadpool_io_old.zig, thread_pool_stub recreation)
- [x] Removed non-runtime files (lsp_async, package_async, tls13_async, zquic_integration)

### Documentation & Examples
- [x] Created `docs/README.md` - Overview and quick start
- [x] Created `docs/getting-started.md` - Installation and usage guide
- [x] Created `docs/api-reference.md` - Full API documentation
- [x] Created `docs/architecture.md` - System design and internals
- [x] Created `examples/README.md` - Examples index
- [x] Created `examples/basic.zig` - Basic runtime usage
- [x] Created `examples/channels.zig` - Channel message passing
- [x] Created `examples/timers.zig` - Timer functionality
- [x] Created `examples/sync.zig` - Synchronization primitives

### Zig 0.16.0-dev Compatibility
- [x] Fixed `std.time.timestamp()` → `std.posix.clock_gettime(.REALTIME).sec` (50 occurrences in 9 files)
- [x] Fixed broken `resume`/`anyframe` in scheduler.zig (language-level async removed in Zig 0.16)
- [x] Fixed deprecated `suspend` blocks in io.zig (TcpListener, UdpSocket)
- [x] Updated file headers to remove old version numbers (35 files)
- [x] Cleaned deprecated patterns and outdated comments

### Developer Tooling
- [x] Created `dev/` local CI infrastructure
- [x] `dev/ci.sh` - Full CI suite (build, test, lint, compat)
- [x] `dev/check-zig-compat.sh` - Zig 0.16 deprecated API scanner
- [x] `dev/memcheck.sh` - Memory leak detection (GPA + valgrind)
- [x] Updated `.gitignore` to prevent future junk

---

## Verification

```
Build:      PASSING
Tests:      33 passed, 0 skipped, 0 failed
Compat:     No issues found
CI:         All 5 checks passed
```

---

## Key Zig 0.16 API Reference

### Time API (REMOVED in 0.16)
```zig
// OLD (removed)
std.time.timestamp()
std.time.nanoTimestamp()
std.time.milliTimestamp()

// NEW
const ts = std.posix.clock_gettime(.REALTIME);
const epoch_sec: i64 = @as(i64, ts.sec);

// For timing measurements
var timer = try std.time.Timer.start();
const elapsed_ns = timer.read();
```

### Language-Level Async (REMOVED in 0.16)
```zig
// OLD (removed)
anyframe
resume frame_ptr
suspend
@asyncCall

// NEW - Use library-level async (std.Io)
var io: std.Io.Threaded = .init(gpa);
const future = io.async(my_function, .{args});
const result = future.await(io);
```

### ArrayList (Unmanaged by default)
```zig
// Correct pattern for Zig 0.16
var list: std.ArrayList(T) = .{};
defer list.deinit(allocator);
try list.append(allocator, item);
```

---

## std.Io Interface Alignment

Aligned zsync with Zig 0.16's new std.Io interface patterns:
- [x] Implemented std.Io compatible interface (`src/std_io.zig`)
- [x] Support `io.async()` and `io.concurrent()` semantics
- [x] Implemented proper cancellation with `future.cancel()`
- [x] VTable-based design for plug-and-play std.Io implementation
- [x] Threaded and Blocking backend implementations
- [x] Exported via `root.zig` as `std_io`

---

## Real Async Runtime (Tokio-style)

Implemented real concurrent execution capabilities:

### Threaded Backend (`src/std_io.zig`)
- [x] Real thread pool with worker threads
- [x] SinglyLinkedList run queue for task dispatch
- [x] Condition variable signaling for worker wakeup
- [x] Automatic thread spawning up to CPU count limit
- [x] AsyncClosure with trailing context/result data
- [x] Futex-based ResetEvent for task completion
- [x] Thread-local storage for cancel detection
- [x] Proper async/concurrent task execution

### Tokio-style Primitives (`src/root.zig`)
- [x] `spawnBlocking()` - Spawn CPU work on dedicated threads
- [x] `JoinSet(T)` - Manage groups of concurrent tasks
- [x] `BroadcastChannel(T)` - Multi-producer, multi-consumer pub/sub
- [x] `WatchChannel(T)` - Single-value observer pattern
- [x] `Notify` - Task notification primitive
- [x] `OnceCell(T)` - Thread-safe lazy initialization
- [x] `CancellationToken` - Graceful shutdown coordination
- [x] `RuntimeBuilder` - Fluent runtime configuration
- [x] `Interval` - Repeating timer with `tick()` method
- [x] `interval()` - Create repeating timers

### Timer System (`src/timer.zig`)
- [x] Implemented `interval()` for repeating timers
- [x] `scheduleInterval()` and `scheduleIntervalWithData()` on TimerWheel
- [x] Global timer wheel with auto-initialization
- [x] `timeout()` for one-shot timers
- [x] `processGlobalTimers()` for event loop integration

### WebSocket (RFC 6455) (`src/net/websocket.zig`)
- [x] Full frame parsing with FIN, RSV, opcode, masking
- [x] Extended payload length (16-bit and 64-bit)
- [x] Automatic ping/pong handling
- [x] Fragmented message reassembly
- [x] Client masking (crypto.random)
- [x] HTTP Upgrade handshake (client & server)
- [x] Sec-WebSocket-Accept key generation (SHA1 + Base64)
- [x] URL parsing for ws:// and wss://
- [x] Close frame handling with status codes

### Zero-Copy I/O (`src/zero_copy.zig`)
- [x] BufferPool with page-aligned allocation
- [x] sendfile support (Linux native, fallback for others)
- [x] splice support (Linux pipes)
- [x] ZeroCopyRingBuffer for circular buffer ops
- [x] Buffer pinning for DMA operations
- [x] Reference counting for shared buffers

---

## Tokio-Style Architecture Cleanup

zsync is now a dependency-free async runtime foundation (like Tokio's core).
Protocol implementations moved to dedicated libraries.

### Removed Protocol Code
- [x] `src/http/` directory removed (HTTP client/server → zhttp)
- [x] `src/grpc/` directory removed (gRPC client/server → zrpc)
- [x] `src/net/doq.zig` removed (DNS over QUIC → zquic)
- [x] `src/quic_http3.zig` removed (HTTP/3 → zhttp)

### Ecosystem Architecture
```
┌─────────────────────────────────────────┐
│              User Application           │
├─────────┬─────────┬─────────┬───────────┤
│  zrpc   │  zhttp  │  zquic  │  others   │  ← Protocol libs
├─────────┴─────────┴─────────┴───────────┤
│                 zsync                    │  ← Async runtime
├─────────────────────────────────────────┤
│            Zig std / OS                  │
└─────────────────────────────────────────┘
```

### What zsync Keeps
- Thread pool / io_uring backends
- Timers, channels, futures
- Basic TCP/UDP/Unix sockets
- Zero-copy primitives (sendfile, splice, mmap)
- Synchronization (mutex, semaphore, condition)
- WebSocket (useful for runtime dev tooling/HMR)
- Rate limiting, connection pooling
- File watching
